"use strict";const DEFAULT_PFP="http://sander.vonk.one/VITE/img/icon/pfp.png";var verificationInterval;function firstPage(){$("#auth-box").removeClass("second"),$("#auth-form").removeClass("inactive"),$("#verification-box").addClass("inactive"),$("#title-text").text("Get Started")}function secondPage(){$("#verification-email").text(auth.currentUser.email),$("#auth-box").addClass("second"),$("#auth-form").addClass("inactive"),$("#verification-box").removeClass("inactive"),$("#title-text").text("Verify your Email")}function openOnboard(){window.location.href="./onboarding.html"+("true"==params.get("classPanel")?"?classPanel=true":"")}function openApp(){params&&params.get("redirect")?new Toast("Redirecting...","default",2e3,"img/icon/success-icon.svg",params.get("redirect")):window.location.href="./app/"+("true"==params.get("classPanel")?"?classPanel=true":"")}function authError(e){console.warn("caught and showed error: ",e),$("#email-input, #password-input").removeClass("error"),new Toast(e.message,"default",2e3,"img/icon/error-icon.png"),e.code.includes("password")&&$("#password-input").addClass("error"),e.code.includes("email")&&$("#email-input").addClass("error"),""==$("#password-input").val()&&$("#password-input").addClass("error")}function providerError(e,t){new ErrorToast(e+" auth error",t.message,1e3+50*t.message.length)}function resetEmail(){auth.sendPasswordResetEmail($("#email-input").val()).then((e=>{new Toast("Sent password reset email","default",2e3,"img/icon/success-icon.svg")})).catch((e=>{new ErrorToast("Error sending reset email",e.message.replace("Error: ",""),2e3)}))}function verifyButton(e){$(document.body).on("click","#send-verification:not(.ready)",(function(){null==verificationInterval&&(verificationInterval=setInterval((function(){e.reload(),auth.currentUser.emailVerified&&(clearInterval(verificationInterval),$("#send-verification").val("Verified!"),$("#send-verification").css({opacity:1,"background-color":"#57DD35","border-color":"#35BB13"}),$("#send-verification").addClass("ready"),new Toast("Email Verified... Logging in","default",2e3,"img/icon/success-icon.png","./"))}),1e3)),e.sendEmailVerification().then((function(){$("#send-verification").val("Resend Verification"),$("#send-verification").css({opacity:.5})}),(function(e){alert("Something went wrong sending your verification email, try again later! \n\n"+e)}))}))}function addDisplayName(){let e=db.collection("users").doc("names"),t=auth.currentUser.uid;return db.runTransaction((r=>r.get(e).then((a=>{if(!Object.keys(a.data()).includes(t)||a.data()[t]!=[auth.currentUser.displayName,auth.currentUser.email,auth.currentUser.photoURL?auth.currentUser.photoURL:DEFAULT_PFP]){let a={};a[t]=[auth.currentUser.displayName,auth.currentUser.email,auth.currentUser.photoURL?auth.currentUser.photoURL:DEFAULT_PFP],r.update(e,a,{merge:!0})}}))))}$("#change-email, #back-button").on("click",firstPage),$(document.body).on("click","#send-verification.ready",(function(){window.location.reload()})),$("#email-input, #password-input").change((function(){$(this).removeClass("error")})),auth.onAuthStateChanged((e=>{if(e){console.log("user logged in:");let t=auth.currentUser.metadata,r=!1;if(userDoc().get().then((e=>{let t=e.data();[t.tenses,t.subjects,t.verbs,t.path].includes(void 0)&&(r=!0),localStorage.setItem("userData",JSON.stringify(t)),localStorage.setItem("userId",auth.getUid())})),auth.currentUser.emailVerified||null==auth.currentUser.email||auth.currentUser.providerData&&("github.com"==auth.currentUser.providerData[0].providerId||"facebook.com"==auth.currentUser.providerData[0].providerId||"twitter.com"==auth.currentUser.providerData[0].providerId))if(t.creationTime===t.lastSignInTime){let e={};e[auth.getUid]=auth.currentUser.displayName,db.collection("users").doc("names").update(e,{merge:!0}).then((()=>{openOnboard()})).catch((e=>{openOnboard()}))}else r?new Toast("Some account data is missing, opening onboarding","default",1e3,"/VITE/img/icon/error-icon.svg","./onboarding.html?showTutorial=false"):addDisplayName().then((()=>{openApp()})).catch((e=>{console.error("error adding name",e),openApp()}));else auth.currentUser.isAnonymous?new Toast("Logged in as guest, your progress will not be saved!","default",1e3,"/VITE/img/icon/info-icon.svg","./onboarding.html"):(secondPage(),verifyButton(e))}else console.log("user logged out"),localStorage.setItem("userData",""),localStorage.setItem("userId","")}));const authForm=$("#auth-form");function eduSignup(){$("#extended-options").hide(),params.set("classPanel",!0),new Toast("You'll be redirected to the class dashboard after completing the tutorial!","default",5e3,"img/icon/group-info-icon.svg")}authForm.on("submit",(e=>{auth.signOut(),e.preventDefault();const t=authForm[0]["email-input"].value,r=authForm[0]["password-input"].value;e.originalEvent&&"signup"==e.originalEvent.submitter.id?auth.createUserWithEmailAndPassword(t,r).then((e=>{$("#password-input, #email-input").removeClass("error"),secondPage(),userDoc().set({joined:(new Date).getTime(),prefs:{theme:"light",pacing:"no",saves:"yes"}},{merge:!0}),authForm[0].reset()})).catch((e=>authError(e))):auth.signInWithEmailAndPassword(t,r).then((e=>{$("#password-input, #email-input").removeClass("error"),authForm[0].reset()})).catch((e=>authError(e)))})),$("#oauth-login").click((e=>{e.preventDefault();let t=new firebase.auth.GoogleAuthProvider;t.addScope("profile"),t.addScope("email"),firebase.auth().signInWithPopup(t).catch((e=>providerError("Google",e)))})),$("#github-login").click((e=>{e.preventDefault();let t=new firebase.auth.GithubAuthProvider;t.addScope("profile"),t.addScope("email"),firebase.auth().signInWithPopup(t).catch((e=>providerError("Github",e)))})),$("#facebook-login").click((e=>{e.preventDefault();let t=new firebase.auth.FacebookAuthProvider;firebase.auth().signInWithPopup(t).catch((e=>providerError("Facebook",e)))})),$("#twitter-login").click((e=>{e.preventDefault();let t=new firebase.auth.TwitterAuthProvider;firebase.auth().signInWithPopup(t).catch((e=>providerError("Twitter",e)))})),"true"==params.get("classPanel")&&eduSignup();
