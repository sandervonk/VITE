var studentClass,studentClassID,userNamesJSON,userClasses={};function setupApp(){return new Promise((function(e,s){db.collection("users").doc("names").get().then(t=>{userNamesJSON=t.data(),userDoc().get().then(t=>{let a=t.data();(userClasses=t.data().classes)&&(t.data().classcode||""==t.data().classcode)||userDoc().set({classes:[],classcode:""},{merge:!0}).then(()=>{window.location.reload()}).catch(e=>{new ErrorToast("Error setting up default class data",e.toString(),2e3,".")}),$("#class-index").text((userClasses.length>0?"1":"0")+"/"+userClasses.length),currentClass=userClasses[0],params&&params.has("class")?HTMLFromID(params.get("class")).then(()=>{e()}).catch(e=>{s(e)}):userClasses.length>0?HTMLFromID(currentClass).then(()=>{e()}).catch(e=>{s(e)}):studentJoin(a)})}).catch(e=>{new ErrorToast("Error loading classes from user document",e.toString(),2e3),s(e)})}))}function removeSavedClassCode(){userDoc().update({classcode:""},{merge:!0}).then(()=>{window.location.reload()}).catch(e=>{new ErrorToast("Error removing saved class code",e.code,2e3)})}function studentInClass(){$("#student-leave-class").show(),$("#student-join-class, #bottom-actions").hide(),$("#student-leave-class, #student-leave-class *").removeClass("disabled"),$("#student-join-class, #student-join-class *").addClass("disabled"),$("#title-text").text("Student Class Dashboard"),$("#student-join-options .section-title").text("Your Class:"),$("#student-class-name").text(studentClass.name),$("#student-class-description").text(studentClass.description),$("#student-class-code").val(studentClassID),"private"==studentClass.visibility&&$("#lock-icon").addClass("alt"),$("[memberlist] > .class-member").remove(),studentClass.members.forEach(e=>setupMember(e)),studentClass.members.length<1&&$("[memberlist]").append("<li class='class-member'>No members yet</li>")}function studentNotInClass(){$("#student-leave-class").hide(),$("#student-join-class").show(),$("#add-button").text("CREATE CLASS"),$("#student-leave-class, #student-leave-class *").addClass("disabled"),$("#student-join-class, #student-join-class *").removeClass("disabled"),new Toast("Looks like you dont have a class yet, lets get you started creating one. Try clicking the 'create class' button below","default",2e3,"/VITE/img/icon/warning-icon.svg")}function studentJoin(e){console.log("setting up student join options"),$("[forstudent]").show(),e.classcode?classDoc(e.classcode).get().then(s=>{s.exists&&s.data().members.includes(auth.getUid())?(studentClass=s.data(),studentClassID=e.classcode,studentInClass(s)):s.exists?(studentClass=s.data(),studentClassID=e.classcode,"public"==studentClass.visibility||studentClass.invited.includes(auth.getUid())||studentClass.invited.includes(auth.currentUser.email)?(new Toast("Looks like you're in a class, but not its member's list, adding you now...","default",2e3,"/VITE/img/icon/warning-icon.svg"),classDoc(doc.data().classcode).update({members:firebase.firestore.FieldValue.arrayUnion(auth.getUid())}).then(()=>{window.location.reload()})):(new Toast("You're a saved member of a class, but it looks like it's private and you weren't invited, removing saved value","default",2e3,"/VITE/img/icon/warning-icon.svg"),removeSavedClassCode())):(new Toast("Found saved class code, but did not match any classes, removing","default",2e3,"/VITE/img/icon/warning-icon.svg"),removeSavedClassCode())}).catch(e=>{studentNotInClass()}):studentNotInClass()}function createClass(){new Toast("Creating a new class","default",750,"/VITE/img/icon/info-icon.svg","./create.html")}function setupMember(e){memberText=e==auth.currentUser.uid?"[You]":userNamesJSON[e][0]+" ("+userNamesJSON[e][1]+")",memberStyle=userNamesJSON[e][2]?`style='background-image: url(${fixPFPResolution(userNamesJSON[e][2])})'`:"",cm_options=e==auth.currentUser.uid||studentClass?"":`{ "icon": "cm-remove", "text": "Remove Student", "onclick": "removeStudentPopup( \`${memberText}\`, \`${e}\` )"}`,$("[memberlist]").append(`<li class='class-member' cm-options='${cm_options}' memberid='${e}' title='${memberText}' ${memberStyle}></li>`)}function cycleClasses(e){let s=userClasses.indexOf(currentClass)+e;return s<0?s=userClasses.length-1:s>userClasses.length-1&&(s=0),currentClass=userClasses[s],$("#class-index").text(s+1+"/"+userClasses.length),userClasses[s]}function HTMLFromID(e){return new Promise((function(s,t){classDoc(e).get().then((function(t){t=t.data(),$("#class-name").text(t.name),$("#class-description").text(t.description),$("#join-code").val(e),"private"==t.visibility?($("#lock-icon").addClass("alt"),$("#invites-list").show(),$("#invites-list > li").remove(),t.invited.forEach((function(e){$("#invites-list").append(`<li email="${e}">${e}</li>`)}))):($("#lock-icon").removeClass("alt"),$("#invites-list").hide()),$("[memberlist] > .class-member").remove(),$(".member-list-ui").show(),t.members.forEach(e=>setupMember(e)),$("[classload]").show(),userClasses.length>1&&$("#bottom-actions > *").removeClass("disabled"),$("#delete-button, #manage-button").removeClass("disabled"),$("#class-index").text(userClasses.indexOf(e)+1+"/"+userClasses.length),s()})).catch(e=>{new ErrorToast("Error loading class",e.toString(),2e3),$("[classload]").hide(),$("#bottom-actions > *:not(#add-button)").addClass("disabled"),$("#delete-button, #manage-button").addClass("disabled"),t(e)})}))}function deleteClass(){classDoc(currentClass).delete().then(()=>{userDoc().update({classes:firebase.firestore.FieldValue.arrayRemove(currentClass)},{merge:!0}).then(()=>{removePopup(),window.location.reload()})}).catch(e=>{new ErrorToast("Error deleting class",e.code,2e3),$("#delete-button").removeClass("disabled")})}function joinClass(e){classDoc(e).get().then(s=>{prospectiveClass=s.data(),"public"==prospectiveClass.visibility||prospectiveClass.invited.includes(auth.getUid())||prospectiveClass.invited.includes(auth.currentUser.email)?classDoc(e).update({members:firebase.firestore.FieldValue.arrayUnion(auth.getUid())}).then(()=>{userDoc().update({classcode:e}).then(()=>{new Toast("Joined class successfully!","default",2e3,"/VITE/img/icon/success-icon.svg","./index.html")}).catch(e=>{new ErrorToast("Could not save class code to user data",e.code,2e3)})}).catch(e=>{new ErrorToast("Something went wrong adding you to the members list",e.code,2e3)}):new Toast("Sorry, this class is private, and you haven't been invited yet","default",2e3,"/VITE/img/icon/warning-icon.svg")}).catch(e=>{new Toast("Could not find a class for this code: ",e.toString(),"default",2e3,"/VITE/img/icon/warning-icon.svg")})}function leaveClass(){$("#student-leave-class, #student-leave-class *").removeClass("disabled"),classDoc(studentClassID).update({members:firebase.firestore.FieldValue.arrayRemove(auth.getUid())}).then(()=>{userDoc().update({classcode:""}).then(()=>{new Toast("Left class successfully!","default",2e3,"/VITE/img/icon/success-icon.svg","./index.html")}).catch(e=>{new ErrorToast("Could not remove class code from user data",e.code,2e3)})}).catch(e=>{new ErrorToast("Something went wrong removing you from the members list",e.code,2e3)}),removePopup()}function copyJoinCode(){el=$(this).children(".codebox")[0]?$(this).children(".codebox")[0]:$(".codebox")[0],""==el.value?new Toast("Make sure you've created a class to get your code, then tap here again to copy it","default",2e3,"/VITE/img/icon/warning-icon.svg"):(el.focus(),el.select(),navigator.clipboard.writeText(el.value).then(e=>{console.log("Copied to clipboard"),new Toast("Copied class code to clipboard","transparent",750,"/VITE/img/icon/clipboard-icon.svg")}).catch(e=>{new ErrorToast("Error copying class code"+e.toString(),2e3),$("#join-code, #student-class-code").removeAttr("disabled")}))}function removeStudent(e){classDoc(currentClass).update({members:firebase.firestore.FieldValue.arrayRemove(e)}).then(()=>{new Toast("Removed student successfully!","default",2e3,"/VITE/img/icon/success-icon.svg"),removePopup(),$(`.class-member[member-id="${e}"]`).remove()}).catch(e=>{new ErrorToast("Error removing student",e.code,2e3),removePopup()})}function removeStudentPopup(e,s){new Popup(`Are you sure you want to remove ${e} from this class?`,"box fullborder default",1e4,"/VITE/img/icon/info-icon.svg",[["removePopup()","Cancel","secondary-action fullborder"],[`removeStudent('${s}')`,"Remove","primary-action blue-button delete-document"]])}function getCMOptions(){let e=[];return(currentClass||studentClass)&&e.push({icon:"cm-copy",text:"Copy class code",onclick:(studentClass?'$("#student-info-code-row").click();':'$("#class-code").click();')+"closeContextMenu()"}),studentClass||e.push({icon:"cm-class",text:"Create Class",onclick:'window.location.href = "./create.html"'}),!!e.length&&e}$("[classload], [forstudent]").hide(),$("#class-code, #student-info-code-row").click(copyJoinCode),$("#delete-button").click((function(){$(this).addClass("disabled"),new Popup("Do you want to delete this class?","box fullborder default",1e4,"/VITE/img/icon/info-icon.svg",[["removePopup(); $('#delete-button').removeClass('disabled')","Cancel","secondary-action fullborder"],["deleteClass()","Yes","primary-action blue-button delete-document"]])})),$("#student-leave-button").click((function(){$(this).addClass("disabled"),new Popup("Are you sure you want to leave this class?","box fullborder default",1e4,"/VITE/img/icon/info-icon.svg",[["removePopup(); $('#student-leave-class, #student-leave-class *').removeClass('disabled')","Cancel","secondary-action fullborder"],["leaveClass()","Yes","primary-action blue-button delete-document"]])})),$("#student-join-button").click((function(){let e=$("#student-join-code").val();""==e?new Toast("Please enter a class code","default",2e3,"/VITE/img/icon/warning-icon.svg"):joinClass(e)}));